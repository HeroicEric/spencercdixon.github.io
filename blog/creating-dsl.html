<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Spencer Dixon - Creating a DSL in Ruby</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml" />
    <link href="../stylesheets/all.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <div class="wrapper">
      <aside>
        <nav class="main-nav">
<a href="../">    <img class="round-image" src="../images/spencer.jpeg" />
</a>
  <ul class="nav-links">
    <li class="text-center"><a href="../about.html">ABOUT</a></li>
    <li class="text-center"><a href="../">BLOG</a></li>
    <li class="text-center"><a href="../book_list.html">BOOKS</a></li>
  </ul>

  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
    <form action="//spencerdixon.us11.list-manage.com/subscribe/post?u=019dc2164dbdc16d844cf6dc2&amp;id=666e212a4d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">

        <div class="mc-field-group">
          <label for="mce-EMAIL" style="display: none;">Email Address </label>
          <input type="email" placeholder="Email To Subscribe" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
        <div id="mce-responses" class="clear">
          <div class="response" id="mce-error-response" style="display:none"></div>
          <div class="response" id="mce-success-response" style="display:none"></div>
        </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;"><input type="text" name="b_019dc2164dbdc16d844cf6dc2_666e212a4d" tabindex="-1" value=""></div>
        <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" style="display: none;" class="button"></div>
      </div>
    </form>
  </div>
  <!--End mc_embed_signup-->

  <section class="social-media">
    <ul>
      <li class="social-icon">
<a target="_blank" href="https://github.com/spencercdixon">          <i class="fa fa-github-square fa-2x"></i>
</a>      </li>
      <li class="social-icon">
<a target="_blank" href="https://twitter.com/SpencerCDixon">          <i class="fa fa-twitter-square fa-2x"></i>
</a>      </li>
      <li class="social-icon">
<a target="_blank" href="https://www.linkedin.com/in/spencercdixon">          <i class="fa fa-linkedin-square fa-2x"></i>
</a>      </li>
    </ul>
  </section>
</nav>

<footer>
  Handcrafted Bytes<br />
  Made With <i class="fa fa-diamond"></i> <br />
  By Spencer Dixon
</footer>


      </aside>

      <article class="blog-post">
            <h1 id="article-title">Creating a DSL in Ruby</h1>
    <hr>
    <div class="tags">
      <ul>
        <li class="tag"><a href="tags/ruby.html">ruby</a></li>
        <li class="tag"><a href="tags/rails.html">rails</a></li>
      </ul>
    </div>

  <p>Recently I built a small DSL for work that allows users to sync data to MongoDB
from any external API.  It was my first time making a DSL so I decided to
document a few things that helped me get started:</p>

<p></p>

<h4>Using Ruby&#39;s <code>included</code> hook to extend class methods</h4>
<pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">CustomDsl</span>
  <span class="k">def</span> <span class="nf">included</span><span class="p">(</span><span class="n">base_class</span><span class="p">)</span>
    <span class="n">base_class</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="no">DslClassMethods</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">instance_method_here</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">get_class_method</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">DslClassMethods</span>
  <span class="k">def</span> <span class="nf">class_method_name</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="vi">@_class_method_name</span> <span class="o">=</span> <span class="n">conn</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_class_method</span>
    <span class="vi">@_class_method_name</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>So now when the <code>CustomDsl</code> gets included in one of my classes that uses the Dsl
it will also extend the <code>DslClassMethods</code>.  Extending that module will make all
methods defined in it class methods instead of instance methods.</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Example</span>
  <span class="kp">include</span> <span class="no">CustomDsl</span>

  <span class="n">class_method_name</span> <span class="ss">:apple</span>
<span class="k">end</span>

<span class="n">foo</span> <span class="o">=</span> <span class="no">Example</span><span class="p">.</span><span class="nf">new</span>

<span class="n">foo</span><span class="p">.</span><span class="nf">instance_method_here</span> <span class="c1"># =&gt; :apple</span>
</code></pre>

<p>One thing to note is that the instance variable <code>@_class_method_name</code> is
somewhat deceiving.  Since DslClassMethods is being extended it&#39;s actually an instance
variable on the Class <code>Example</code>, not a normal instance variable.</p>

<h4>Usings macros for configuration</h4>

<p>I ended up using class macros for a lot of configuration.  It was important to
me that end users of the DSL be informed of error messages if they had a typo or
were missing key components to make the DSL work.  For example, if a class was suppose to use a
specific Connection class to hit an API, I wanted to confirm that 
Connection class actually existed.  The implementation I choose to use involves
some simple metaprogramming and <code>Object.const_get</code>. </p>
<pre class="highlight ruby"><code><span class="k">module</span> <span class="nn">CustomDsl</span>
  <span class="k">def</span> <span class="nf">included</span><span class="p">(</span><span class="n">base_class</span><span class="p">)</span>
    <span class="n">base_class</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="no">DslClassMethods</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="c1"># ... emitted ...</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">DslClassMethods</span>
  <span class="k">def</span> <span class="nf">primary_connection</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">confirm_symbol_or_string!</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">const</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'_'</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:capitalize</span><span class="p">).</span><span class="nf">join</span>
    <span class="no">Object</span><span class="p">.</span><span class="nf">const_get</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
    <span class="vi">@_primary_connection</span> <span class="o">||=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">to_sym</span>
  <span class="k">rescue</span> <span class="no">NameError</span>
    <span class="k">raise</span> <span class="no">UndefinedConnectionClass</span><span class="p">,</span> 
      <span class="s2">"</span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2"> wants to use </span><span class="si">#{</span><span class="n">const</span><span class="si">}</span><span class="s2"> as its primary connection but </span><span class="si">#{</span><span class="n">const</span><span class="si">}</span><span class="s2"> has not yet been defined"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p><code>primary_connection</code> is now able to take symbols or strings but it makes sure to
always save the connection as a symbol.  If <code>Object.const_get</code> is unable to find
the connection class then I rescue the <code>NameError</code> and provide a more
descriptive error message.  The final implementation for this macro might look
something like:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">SlackDataSource</span>
  <span class="kp">include</span> <span class="no">CustomDsl</span>
  <span class="n">primary_connection</span> <span class="ss">:slack_connection</span>
<span class="k">end</span>
</code></pre>

<p>This is really just the start but hopefully there is enough context for someone
interested in making their own DSL to have some direction.</p>


  <a href="#" id="hide_comments">Hide Comments<a>
    <div id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
                  var disqus_shortname = 'spencerdixon';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </article>
    </div>

    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-51806130-1', 'auto');
  ga('send', 'pageview');
</script>
    <script src="../javascripts/all.js" type="text/javascript"></script>
  </body>
</html>
